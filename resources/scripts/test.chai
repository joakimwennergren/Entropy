global width = 0.0;
global height = 0.0;
global tick = 0.0;
global leaves = [];
global instanciated_mushrooms = [];
global touchPoint;

global title = Sprite("title.png");
global layer_1 = Sprite("layer_1.png");
global layer_2 = Sprite("layer_2.png");
global layer_3 = Sprite("layer_3.png");
global playButton = Sprite("play.png");
global background = Sprite("background.png");
global GulKantarell = Sprite("gul_kantarell.png");
global Bombmurkla = Sprite("Bombmurkla.png");
global Eldsopp = Sprite("Eldsopp.png");
global Fjallskivling = Sprite("Stolt fjaÌˆllskivling.png");
global Vaxskivling = Sprite("Vaxskivling.png");
global points = Sprite("points.png");

global Leaf1 = Sprite("leaf1.png");
global Leaf2 = Sprite("leaf2.png");
global Leaf3 = Sprite("leaf3.png");
global Leaf4 = Sprite("leaf4.png");

global mushrooms = [GulKantarell, Bombmurkla, Eldsopp, Fjallskivling, Vaxskivling];

// @test
global label = Label();

label.SetZIndex(10);
Graph.Add(label);
Graph.Add(title);
//Graph.Add(playButton);
//Graph.Add(points);
Graph.Add(background);

title.SetZIndex(99);
playButton.SetZIndex(99);
points.SetZIndex(99);
Graph.Add(layer_1);
layer_1.SetZIndex(3);
background.SetZIndex(1);

/*
Graph.Add(GulKantarell);
Graph.Add(Bombmurkla);
Graph.Add(Eldsopp);
Graph.Add(Fjallskivling);
Graph.Add(Vaxskivling);
*/

// Layer 1 possible positions
class Position
{
  var x;
  var y;

  def Position(x, y) { 
  	this.x = x;
  	this.y = y;
  }

  def getX() { return this.x; }
  def getY() { return this.y; }
};

global layer1PossiblePositions = [
	Position(300.0, 340.0),
	Position(550.0, 350.0),
	Position(750.0, 370.0),
	Position(950.0, 370.0),
	Position(1150.0, 350.0),
	Position(1350.0, 390.0),
	Position(1550.0, 360.0),
	Position(1750.0, 370.0),
	Position(1950.0, 370.0),
	Position(2150.0, 370.0)

]

class Mushroom 
{
	var sprite;
	var scale;
	var x;
	var y;
	var yOffset
	var id;

	def Mushroom() {

		var spriteIndex = random(0, mushrooms.size());

		var random_num = random(0, 100000);
		this.id = random_num;


		var position = layer1PossiblePositions[random(0, layer1PossiblePositions.size())];

		this.sprite = mushrooms[spriteIndex];

		this.sprite.SetId(random_num);
		
		if(spriteIndex == 0) {
			this.scale = random(60, 80);
			this.yOffset = 30.0;
		}
		if(spriteIndex == 1) {
			this.scale = random(70, 90);
			this.yOffset = 20.0;
		}
		if(spriteIndex == 2) {
			this.scale = random(70, 80);
			this.yOffset = 0.0;
		}
		if(spriteIndex == 3) {
			this.scale = 180.0;
			this.yOffset = 0.0;
		}
		if(spriteIndex == 4) {
			this.scale = random(40, 50);
			this.yOffset = 50.0;
		}

		this.x = position.getX();
		this.y = position.getY();

		this.sprite.SetPosition(position.getX(), (position.getY() - this.yOffset) * -1);
		this.sprite.SetScale(this.scale, this.scale);

		if(random(0, 2) == 1)
		{
			this.sprite.SetRotation(180, 2);	
		}


		this.sprite.SetZIndex(2);
		Graph.Add(this.sprite);
	}

	def PopUp()
	{
		var s = easeOutBounce(tick) * 50.0;
		this.sprite.SetScale(s, s);
	}

};

class Leaf 
{
	var x;
	var y;
	var yoff;
	var xVelocity;
	var yVelocity;
	var zIndex;
	var time;
	var mass;
	var sprite;

	def Leaf(x, m, yoff, zIndex)
	{
		this.x = 0.0;
		this.y = 0.0;
		this.mass = 0.0;
		this.xVelocity = 0.0;
		this.yVelocity = 0.0;
		this.yoff = 0.0;
		this.zIndex = 0.0;
		this.time = 0.0;

		this.x = x;
		this.mass = m;
		this.yoff = yoff;
		this.zIndex = zIndex;

		var random = random(0, 4);
		if(random == 0)
		{
			this.sprite = Leaf1;
		}
		if(random == 1)
		{
			this.sprite = Leaf2;
		}
		if(random == 2)
		{
			this.sprite = Leaf3;
		}
		if(random == 3)
		{
			this.sprite = Leaf4;
		}

		this.sprite.SetPosition(300.0, (300.0) * -1);
		this.sprite.SetScale(40.0, 40.0);
		this.sprite.SetZIndex(98);
		this.sprite.SetColor(1.0, 1.0, 1.0, 0.0);
		Graph.Add(this.sprite);
	}

	def update()
	{
		var force = 0.0;
		force += 1.0 * 9.8;

		var acceleration = force / this.mass; 
		this.yVelocity += acceleration * this.time;

		if(this.yVelocity < height)
		{
				this.sprite.SetColor(1.0, 1.0, 1.0, 1.0);
		}

		var xVelocity = this.yVelocity * 0.8;

		this.sprite.SetRotation(this.yVelocity * 0.5, 3);
		this.sprite.SetPosition(this.x - xVelocity - 600.0, this.yVelocity - (height + this.yoff));

		if(this.yVelocity > height + this.yoff)
		{
			this.x = random(2400, 2800)
			this.yoff = random(500, 800);
			this.yVelocity = 0.0;
			this.time = 0.0;
		}

  	this.time += 0.03;
	}

};

for(var i = 0; i < 32; ++i)
{
	var leaf = Leaf(random(2400, 2800), random(10, 30), random(500, 800), random(0, 2));
	leaves.push_back_ref(leaf);
}


for(var i = 0; i < 4; ++i)
{
	var mushroom = Mushroom();
	instanciated_mushrooms.push_back_ref(mushroom);
}



class TouchPoint
{
	var x;
	var y;

	def TouchPoint(){}

	def setX(x) {this.x = x;}
	def SetY(y) {this.y = y;}
};

touchPoint = TouchPoint();


global alpha = 0.0;

global wtf = 600.0;

def OnUpdate()
{

	// Get touch information
	var pointX = TouchPointX();
	var pointY = TouchPointY();
	touchPoint.x = pointX;
	touchPoint.y = pointY;

	for(leaf : leaves)
	{
		leaf.update();
	}

	for(shroom : instanciated_mushrooms)
	{
		if(pointX >= (shroom.x) - shroom.scale &&  pointX <= (shroom.x) + shroom.scale && (height - pointY) <= shroom.y + shroom.scale && (height - pointY) >= shroom.y - shroom.scale)
		{
			shroom.sprite.SetColor(1.0, 1.0, 1.0, 0.0);
		} else 
		{
			//shroom.sprite.SetColor(1.0, 1.0, 1.0, 1.0);
		}	
	}

	background.SetColor(1.0, 1.0, 1.0, alpha);
  
	var scale = easeOutBounce(tick);

	//shroom.PopUp();

	layer_1.SetScale(width, height);
	layer_1.SetPosition(width/2, (height / 2) * -1);

	layer_2.SetScale(width, height);
	layer_2.SetPosition(width/2, (height / 2) * -1);

	playButton.SetScale(100, 100);
	playButton.SetPosition(width/2, (height / 4) * -1);

	points.SetScale(240, 140);
	points.SetPosition(width + 380.0, (height + 200.0) * -1);

	layer_3.SetScale(400, 400);
	layer_3.SetPosition(width/2, (height / 2) * -1);

	title.SetScale(width/2.2 * scale, height/3.0 * scale);
	title.SetPosition(width - (width/4), height/1.4 * -1);

	background.SetScale(width, height);
	background.SetPosition(width/2, (height / 2) * -1);

	//print(height);

	tick = tick + 0.01;

	
	if(pointX >= (width/2) - 100 &&  pointX <= (width/2) + 100 && (height - pointY) <= (height / 4) + 100 && (height - pointY) >= (height / 4) - 100)
	{
		playButton.SetColor(1.0, 1.0, 1.0, 0.5);
	} else 
	{
		playButton.SetColor(1.0, 1.0, 1.0, 1.0);
	}	

	//label.SetText("100");
	//label.SetPosition(wtf, -640.0);

	wtf += 10.0;

	if(alpha < 1.0)
	{
		alpha = alpha + 0.005;	
	}
}

def OnResize(w, h)
{
	width = w;
	height = h;
}
